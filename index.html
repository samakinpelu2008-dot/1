<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>WhatsApp-style Chat Hall</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
* { box-sizing:border-box; margin:0; padding:0; font-family: system-ui, sans-serif; }
body, html { height:100%; width:100%; background:#121b22; color:#e5ddd5; overflow:hidden; }

/* ---------- TOP APP BAR ---------- */
.appbar {
  height:60px;
  background:#075E54;
  display:flex;
  align-items:center;
  justify-content:space-between;
  padding:0 12px;
  position:relative;
  flex-shrink:0;
}
.appbar .left { font-size:20px; font-weight:bold; }
.appbar .right { display:flex; align-items:center; gap:16px; }
.icon { cursor:pointer; font-size:22px; }

/* ---------- DROPDOWN MENU ---------- */
.menu-dropdown {
  position:absolute;
  top:60px;
  right:12px;
  background:#262f34;
  border-radius:8px;
  overflow:hidden;
  display:none;
  flex-direction:column;
  width:180px;
  z-index:10;
}
.menu-item {
  padding:12px 16px;
  cursor:pointer;
}
.menu-item.deactivated { color:#777; pointer-events:none; }
.menu-item:hover { background:#1c262b; }

/* ---------- SEARCH CARD ---------- */
#searchCard {
  position:absolute;
  top:60px; left:0; right:0;
  background:#121b22;
  display:none;
  flex-direction:column;
  z-index:5;
  border-bottom:1px solid #1e2a2f;
}
#searchCard input {
  width:95%;
  margin:10px auto;
  display:block;
  padding:10px 15px;
  border-radius:25px;
  border:none;
  outline:none;
  background:#2a3942;
  color:white;
  font-size:16px;
}

/* ---------- CHAT LIST ---------- */
.chat-list {
  flex:1;
  overflow-y:auto;
  background:#121b22;
}
.chat-item {
  display:flex;
  align-items:center;
  padding:12px 16px;
  gap:12px;
  cursor:pointer;
  border-bottom:1px solid #1e2a2f;
}
.chat-item:hover { background:#1c262b; }
.avatar {
  width:50px; height:50px;
  border-radius:50%;
  background:#25d366;
  display:flex;
  justify-content:center;
  align-items:center;
  font-size:22px;
  font-weight:bold;
  color:black;
}
.chat-name { font-size:16px; font-weight:bold; }
</style>
</head>

<body>
<div id="chatHall" style="display:flex;flex-direction:column;height:100%;">

  <!-- TOP BAR -->
  <div class="appbar">
    <div class="left">IEM Chat</div>
    <div class="right">
      <div class="icon" onclick="toggleSearch()">üîç</div>
      <div class="icon" onclick="toggleMenu()">‚ãÆ</div>
    </div>

    <!-- DROPDOWN MENU -->
    <div id="menu" class="menu-dropdown">
      <div class="menu-item deactivated">New Group</div>
      <div class="menu-item" onclick="addContact()">Add Contact</div>
      <div class="menu-item deactivated">Settings</div>
      <div class="menu-item" onclick="alert('Your User ID: '+myUserId)">User ID</div>
    </div>
  </div>

  <!-- SEARCH CARD -->
  <div id="searchCard">
    <input type="text" placeholder="Search contacts..." onkeyup="filterContacts(this.value)">
  </div>

  <!-- CHAT LIST -->
  <div id="chatList" class="chat-list">
    <!-- Contacts from Firebase will appear here -->
  </div>

</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
import { getFirestore, collection, onSnapshot } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyDCBD2gVIg9v-KqYaMFZeu_grgs3yKYfPs",
  authDomain: "fir-chat-f8d55.firebaseapp.com",
  projectId: "fir-chat-f8d55",
  storageBucket: "fir-chat-f8d55.appspot.com",
  messagingSenderId: "792896094694",
  appId: "1:792896094694:web:dd373e5d7d2fc9ae1d5627"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

let myUID,myUserId;
let contactsList = []; // will store Firebase contacts

// ---------- AUTH ----------
onAuthStateChanged(auth, async user=>{
  if(!user) return alert("You must be logged in first");
  myUID = user.uid;

  // get user's UserID
  const userDoc = await db.collection("users").doc(myUID).get();
  myUserId = userDoc.data().userId;

  // load contacts
  loadContacts();
});

// ---------- LOAD CONTACTS ----------
function loadContacts(){
  const colRef = collection(db,"contacts",myUID,"list");
  onSnapshot(colRef, snap=>{
    contactsList = [];
    snap.forEach(doc=>{
      contactsList.push({ name: doc.data().name, id: doc.data().userId });
    });
    renderContacts(contactsList);
  });
}

// ---------- RENDER ----------
function renderContacts(list){
  const chatList = document.getElementById("chatList");
  chatList.innerHTML="";
  list.forEach(c=>{
    const div = document.createElement("div");
    div.className="chat-item";
    div.innerHTML = `<div class="avatar">${c.name[0]}</div>
                     <div class="chat-name">${c.name}-${c.id}</div>`;
    chatList.appendChild(div);
  });
}

// ---------- SEARCH ----------
function filterContacts(text){
  const filtered = contactsList.filter(c=>
    c.name.toLowerCase().includes(text.toLowerCase()) ||
    c.id.toLowerCase().includes(text.toLowerCase())
  );
  renderContacts(filtered);
}

function toggleMenu(){
  const menu = document.getElementById("menu");
  menu.style.display = menu.style.display==="flex"?"none":"flex";
}

function toggleSearch(){
  const search = document.getElementById("searchCard");
  search.style.display = search.style.display==="flex"?"none":"flex";
  search.querySelector("input").focus();
}

// ---------- ADD CONTACT PLACEHOLDER ----------
function addContact(){
  alert("Add Contact clicked (we'll implement the modal next)");
}

// ---------- CLICK OUTSIDE TO CLOSE ----------
document.addEventListener("click", e=>{
  const menu = document.getElementById("menu");
  const search = document.getElementById("searchCard");
  const icons = document.querySelectorAll(".appbar .icon");
  if(!menu.contains(e.target) && !icons[1].contains(e.target)){
    menu.style.display="none";
  }
  if(!search.contains(e.target) && !icons[0].contains(e.target)){
    search.style.display="none";
  }
});
</script>
</body>
</html>
