<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>IEM Chat Login</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
*{margin:0;padding:0;box-sizing:border-box;font-family:system-ui;}
body,html{height:100%;background:#0f1720;color:#e5e7eb;overflow:hidden;}
.app{height:100%;display:flex;flex-direction:column;justify-content:center;align-items:center;padding:20px;}
input{padding:10px 12px;border-radius:8px;border:none;outline:none;width:250px;margin-bottom:15px;}
button{padding:10px 15px;border-radius:8px;border:none;background:#1f2c33;color:white;cursor:pointer;width:270px;}
.hidden{display:none;}
.topbar, .chat-topbar{height:60px;display:flex;align-items:center;justify-content:space-between;padding:0 15px;border-bottom:1px solid #1f2c33;background:#0f1720;color:#e5e7eb;}
.topbar h1, .chat-topbar .name{font-size:20px;font-weight:600;}
.avatar{width:40px;height:40px;background:#1f2c33;border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:bold;font-size:16px;}
.menu, .back-btn{font-size:20px;cursor:pointer;}
.dropdown{position:absolute;right:15px;top:60px;background:#1f2c33;border-radius:6px;display:none;flex-direction:column;overflow:hidden;z-index:100;}
.dropdown div{padding:10px 15px;cursor:pointer;border-bottom:1px solid #111b21;}
.dropdown div:last-child{border:none;}
.dropdown div:hover{background:#111b21;}
.search{padding:10px;background:#111b21;}
.search input{width:100%;padding:10px 15px;border-radius:25px;border:none;outline:none;background:#2a3942;color:white;}
.chat-list{flex:1;overflow-y:auto;width:100%;}
.chat{display:flex;align-items:center;gap:12px;padding:12px 15px;border-bottom:1px solid #1f2c33;cursor:pointer;}
.chat:hover{background:#1c262b;}
.messages{flex:1;padding:15px;overflow-y:auto;display:flex;flex-direction:column;gap:10px;width:100%;}
.message{max-width:70%;padding:10px 14px;border-radius:10px;font-size:14px;line-height:1.4;word-break: break-word;}
.sent{background:#1f2c33;align-self:flex-end;border-bottom-right-radius:0;}
.received{background:#111827;align-self:flex-start;border-bottom-left-radius:0;}
.chat-input{display:flex;gap:10px;padding:10px;border-top:1px solid #1f2c33;width:100%;}
.chat-input input{flex:1;background:#111827;border:none;color:white;padding:12px;border-radius:20px;outline:none;}
.chat-input button{width:45px;height:45px;border-radius:50%;border:none;background:#1f2c33;color:white;cursor:pointer;}
</style>
</head>
<body>
<div id="app" class="app">

  <!-- LOGIN/REGISTER -->
  <div id="loginScreen">
    <h2 style="margin-bottom:20px;">IEM Chat Login/Register</h2>
    <input type="text" id="usernameInput" placeholder="Enter Username">
    <input type="password" id="passwordInput" placeholder="Enter Password">
    <button onclick="loginOrRegister()">Next</button>
    <p id="loginMsg" style="color:red;margin-top:10px;"></p>
  </div>

  <!-- CHAT HALL -->
  <div id="chatHall" class="hidden" style="flex-direction:column;width:100%;height:100%;">
    <div class="topbar">
      <h1>IEM Chat</h1>
      <div style="position:relative;">
        <div class="menu" onclick="toggleDropdown()">⋮</div>
        <div class="dropdown" id="dropdownMenu">
          <div onclick="addContact()">Add Contact</div>
          <div onclick="createGroup()">Create New Group</div>
          <div onclick="showUserId()">User ID</div>
          <div onclick="settings()">Settings</div>
        </div>
      </div>
    </div>
    <div class="search">
      <input placeholder="Search contacts..." onkeyup="filterContacts(this.value)">
    </div>
    <div class="chat-list" id="contactsList"></div>
  </div>

  <!-- CHAT SCREEN -->
  <div id="chatScreen" class="hidden" style="flex-direction:column;height:100%;">
    <div class="chat-topbar">
      <div style="display:flex;align-items:center;gap:10px">
        <div class="back-btn" onclick="backToHall()">←</div>
        <div class="avatar" id="chatAvatar">C</div>
        <div class="name" id="chatName">Contact</div>
      </div>
      <div class="menu" onclick="toggleDropdown()">⋮</div>
      <div class="dropdown" id="chatDropdown">
        <div onclick="groupSettings()">Group Settings</div>
        <div onclick="chatUserId()">User ID</div>
      </div>
    </div>
    <div class="messages" id="messages"></div>
    <div class="chat-input">
      <input type="text" id="messageInput" placeholder="Type a message">
      <button id="sendBtn">➤</button>
    </div>
  </div>

</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getFirestore, doc, setDoc, getDoc, collection, addDoc, onSnapshot, query, orderBy } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyDCBD2gVIg9v-KqYaMFZeu_grgs3yKYfPs",
  authDomain: "fir-chat-f8d55.firebaseapp.com",
  projectId: "fir-chat-f8d55",
  storageBucket: "fir-chat-f8d55.appspot.com",
  messagingSenderId: "792896094694",
  appId: "1:792896094694:web:dd373e5d7d2fc9ae1d5627"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

let currentUserUid=null;
let currentUserName=null;
let allContacts=[];
let currentContact=null;
let chatId=null;
let unsubscribeMessages=null;

// DOM
const loginScreen=document.getElementById("loginScreen");
const usernameInput=document.getElementById("usernameInput");
const passwordInput=document.getElementById("passwordInput");
const loginMsg=document.getElementById("loginMsg");
const chatHall=document.getElementById("chatHall");
const contactsList=document.getElementById("contactsList");
const chatScreen=document.getElementById("chatScreen");
const chatName=document.getElementById("chatName");
const chatAvatar=document.getElementById("chatAvatar");
const messagesDiv=document.getElementById("messages");
const messageInput=document.getElementById("messageInput");
const sendBtn=document.getElementById("sendBtn");

// Helper to generate UID
function generateUserId(name){
  const letters = name.slice(0,4).toUpperCase();
  const number = Math.floor(Math.random()*90000)+10000;
  return letters+number;
}

// Login/Register
window.loginOrRegister = async ()=>{
  const name=usernameInput.value.trim();
  const password=passwordInput.value.trim();
  if(!name || !password){loginMsg.textContent="Fill both fields";return;}
  const usersRef = doc(db,"users",name);
  const userSnap = await getDoc(usersRef);
  if(userSnap.exists()){
    const data = userSnap.data();
    if(data.password===password){
      currentUserUid = data.userId;
      currentUserName = name;
      loginScreen.classList.add("hidden");
      chatHall.classList.remove("hidden");
      loadContacts();
    } else {loginMsg.textContent="Wrong password";}
  } else {
    const userId = generateUserId(name);
    await setDoc(usersRef,{password,name,userId,avatarLetter:name[0].toUpperCase()});
    currentUserUid=userId;
    currentUserName=name;
    loginScreen.classList.add("hidden");
    chatHall.classList.remove("hidden");
    loadContacts();
    console.log(`New user created: ${name} (${userId})`);
  }
};

// Load contacts
async function loadContacts(){
  const contactsRef = collection(db,"contacts",currentUserUid,"list");
  onSnapshot(contactsRef,snap=>{
    allContacts = snap.docs.map(d=>({id:d.id,...d.data()}));
    renderContacts(allContacts);
  });
}

// Render contacts
function renderContacts(list){
  contactsList.innerHTML="";
  list.forEach(c=>{
    const div=document.createElement("div");
    div.className="chat";
    div.innerHTML=`<div class="avatar">${(c.name||c.userId)[0].toUpperCase()}</div><div class="name">${c.name||c.userId}</div>`;
    div.onclick = ()=>openChat(c);
    contactsList.appendChild(div);
  });
}

// Search filter
window.filterContacts=txt=>{
  renderContacts(allContacts.filter(c=>(c.name||c.userId).toLowerCase().includes(txt.toLowerCase())));
}

// Open Chat
function openChat(contact){
  currentContact=contact;
  chatId=[currentUserUid,contact.id].sort().join("_");
  chatName.textContent = contact.name||contact.userId;
  chatAvatar.textContent=(contact.name||contact.userId)[0].toUpperCase();
  chatHall.classList.add("hidden");
  chatScreen.classList.remove("hidden");
  listenMessages();
}

// Back
window.backToHall = ()=>{
  chatScreen.classList.add("hidden");
  chatHall.classList.remove("hidden");
  if(unsubscribeMessages) unsubscribeMessages();
}

// Listen messages
function listenMessages(){
  messagesDiv.innerHTML="";
  const ref = collection(db,"chats",chatId,"messages");
  const q = query(ref,orderBy("timestamp","asc"));
  if(unsubscribeMessages) unsubscribeMessages();
  unsubscribeMessages = onSnapshot(q,snap=>{
    messagesDiv.innerHTML="";
    snap.forEach(doc=>{
      const m = doc.data();
      const div = document.createElement("div");
      div.className="message "+(m.senderUid===currentUserUid?"sent":"received");
      div.textContent=m.text;
      messagesDiv.appendChild(div);
    });
    messagesDiv.scrollTop = messagesDiv.scrollHeight;
  });
}

// Send message
sendBtn.onclick=sendMessage;
messageInput.addEventListener("keydown",e=>{if(e.key==="Enter") sendMessage();});
async function sendMessage(){
  const text=messageInput.value.trim();
  if(!text) return;
  await addDoc(collection(db,"chats",chatId,"messages"),{
    text,
    senderUid: currentUserUid,
    timestamp: Date.now()
  });
  messageInput.value="";
}

// Dummy dropdown actions
function toggleDropdown(){const d=event.currentTarget.nextElementSibling;d.style.display=d.style.display==="flex"?"none":"flex";}
function addContact(){console.log("Add Contact clicked");}
function createGroup(){console.log("Create New Group clicked");}
function showUserId(){console.log(`User ID: ${currentUserUid}`);}
function settings(){console.log("Settings clicked");}
function groupSettings(){console.log("Group Settings clicked");}
function chatUserId(){console.log(`Chat User ID: ${currentContact?.id}`);}
</script>
</body>
</html>
