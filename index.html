<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>IEM Chat</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
*{box-sizing:border-box;font-family:Arial}
body,html{margin:0;height:100%;background:#0b141a;color:white;overflow:hidden}
input,button{padding:12px;border:none;border-radius:20px}
button{background:#25d366;color:black;font-weight:bold;cursor:pointer}
.screen{display:none;height:100%;width:100%}
.center{display:flex;flex-direction:column;justify-content:center;align-items:center;gap:15px}

.header{
  height:60px;
  background:#202c33;
  display:flex;
  align-items:center;
  padding:0 15px;
  gap:15px;
}

.list{overflow-y:auto;height:calc(100% - 60px)}
.contact{
  padding:15px;
  border-bottom:1px solid #333;
  display:flex;
  align-items:center;
  gap:15px;
  cursor:pointer;
}
.avatar{
  width:45px;height:45px;
  background:#25d366;
  border-radius:50%;
  display:flex;
  align-items:center;
  justify-content:center;
  font-size:22px;
  font-weight:bold;
  color:black;
}

.message{
  max-width:70%;
  padding:10px;
  border-radius:10px;
  margin:6px;
}
.me{background:#25d366;color:black;margin-left:auto}
.other{background:#202c33}

#messages{flex:1;overflow-y:auto;padding:10px}
.inputBar{
  display:flex;
  padding:10px;
  gap:10px;
  background:#202c33;
}
input{flex:1}
</style>
</head>

<body>

<!-- LOGIN -->
<div id="login" class="screen center">
  <h2>Register / Login</h2>
  <input id="email" placeholder="Email">
  <input id="password" placeholder="Password" type="password">
  <input id="username" placeholder="Username">
  <button onclick="register()">Continue</button>
</div>

<!-- CHAT HALL -->
<div id="hall" class="screen">
  <div class="header">
    <b>IEM Chat</b>
    <span style="margin-left:auto;cursor:pointer" onclick="addContact()">➕</span>
  </div>
  <div id="contacts" class="list"></div>
</div>

<!-- CHAT -->
<div id="chat" class="screen" style="display:flex;flex-direction:column">
  <div class="header">
    <span onclick="back()">←</span>
    <b id="chatName"></b>
  </div>
  <div id="messages"></div>
  <div class="inputBar">
    <input id="msg">
    <button onclick="send()">Send</button>
  </div>
</div>

<!-- ADD CONTACT -->
<div id="add" class="screen center">
  <h3>Add Contact</h3>
  <input id="contactId" placeholder="User ID">
  <button onclick="saveContact()">Save</button>
  <button onclick="show('hall')">Cancel</button>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import {
  getAuth,
  createUserWithEmailAndPassword,
  signInWithEmailAndPassword,
  onAuthStateChanged
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

import {
  getFirestore,
  doc,setDoc,getDoc,addDoc,
  collection,onSnapshot,query,orderBy,serverTimestamp
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyDCBD2gVIg9v-KqYaMFZeu_grgs3yKYfPs",
  authDomain: "fir-chat-f8d55.firebaseapp.com",
  projectId: "fir-chat-f8d55",
  storageBucket: "fir-chat-f8d55.appspot.com",
  messagingSenderId: "792896094694",
  appId: "1:792896094694:web:dd373e5d7d2fc9ae1d5627"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

let myUID,myUserId,currentChat;

/* UI */
function show(id){
  document.querySelectorAll(".screen").forEach(s=>s.style.display="none");
  document.getElementById(id).style.display="flex";
}
show("login");

/* REGISTER / LOGIN */
window.register = async()=>{
  const e=email.value,p=password.value,u=username.value;
  try{
    const r=await createUserWithEmailAndPassword(auth,e,p);
    const uid=r.user.uid;
    const userId=u.slice(0,4).toUpperCase()+"-"+Math.floor(10000+Math.random()*90000);
    await setDoc(doc(db,"users",uid),{username:u,userId});
  }catch{
    await signInWithEmailAndPassword(auth,e,p);
  }
};

/* AUTH STATE */
onAuthStateChanged(auth,async u=>{
  if(!u)return;
  myUID=u.uid;
  const snap=await getDoc(doc(db,"users",myUID));
  myUserId=snap.data().userId;
  loadContacts();
  show("hall");
});

/* CONTACTS */
function loadContacts(){
  onSnapshot(collection(db,"contacts",myUID,"list"),snap=>{
    contacts.innerHTML="";
    snap.forEach(d=>{
      const c=d.data();
      const div=document.createElement("div");
      div.className="contact";
      div.innerHTML=`
        <div class="avatar">${c.name[0]}</div>
        <div>${c.name}</div>
      `;
      div.onclick=()=>openChat(d.id,c.name);
      contacts.appendChild(div);
    });
  });
}

/* ADD CONTACT */
window.addContact=()=>show("add");
window.saveContact=async()=>{
  const uid=contactId.value;
  const q=await getDoc(doc(db,"users",uid));
  if(!q.exists())return alert("User not found");
  await setDoc(doc(db,"contacts",myUID,"list",uid),{
    name:q.data().username,
    userId:q.data().userId
  });
  show("hall");
};

/* CHAT */
function chatId(a,b){return a<b?a+"_"+b:b+"_"+a}
window.openChat=(uid,name)=>{
  currentChat=chatId(myUID,uid);
  chatName.textContent=name;
  messages.innerHTML="";
  show("chat");

  onSnapshot(
    query(collection(db,"chats",currentChat,"msgs"),orderBy("createdAt")),
    s=>{
      messages.innerHTML="";
      s.forEach(d=>{
        const m=d.data();
        const div=document.createElement("div");
        div.className="message "+(m.sender===myUID?"me":"other");
        div.textContent=m.text;
        messages.appendChild(div);
      });
      messages.scrollTop=messages.scrollHeight;
    }
  );
};

window.send=async()=>{
  if(!msg.value)return;
  await addDoc(collection(db,"chats",currentChat,"msgs"),{
    sender:myUID,
    text:msg.value,
    createdAt:serverTimestamp()
  });
  msg.value="";
};

window.back=()=>show("hall");
</script>
</body>
  </html>
