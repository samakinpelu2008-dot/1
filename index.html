<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>FIR Chat</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">

<style>
* { box-sizing: border-box; }
html, body {
  margin:0;
  width:100%;
  height:100%;
  font-family: system-ui, sans-serif;
  background:#0b141a;
  color:#e9edef;
  overflow:hidden;
}

/* ---------- COMMON ---------- */
button, input {
  border:none;
  outline:none;
  font-size:16px;
}
button {
  background:#25d366;
  padding:12px;
  border-radius:8px;
  font-weight:bold;
  cursor:pointer;
}
input {
  padding:14px;
  border-radius:8px;
  background:#202c33;
  color:white;
}

/* ---------- PAGES ---------- */
.page {
  display:none;
  height:100%;
  width:100%;
  justify-content:center;
  align-items:center;
}

.card {
  width:90%;
  max-width:420px;
  background:#111b21;
  padding:30px;
  border-radius:12px;
  display:flex;
  flex-direction:column;
  gap:16px;
}

/* ---------- CHAT HALL ---------- */
#hall {
  display:none;
  flex-direction:column;
  height:100%;
}

.header {
  height:60px;
  background:#202c33;
  display:flex;
  align-items:center;
  padding:0 15px;
  font-weight:bold;
}

.avatar {
  width:48px;
  height:48px;
  border-radius:50%;
  background:#25d366;
  display:flex;
  align-items:center;
  justify-content:center;
  font-size:28px;
  font-weight:900;
  color:white;
}
</style>
</head>

<body>

<!-- LOGIN -->
<div id="login" class="page" style="display:flex;">
  <div class="card">
    <h2>Login</h2>
    <input id="loginEmail" placeholder="Email">
    <input id="loginPassword" type="password" placeholder="Password">
    <button onclick="login()">Login</button>
    <p onclick="goRegister()" style="cursor:pointer;">Create account</p>
  </div>
</div>

<!-- REGISTER -->
<div id="register" class="page">
  <div class="card">
    <h2>Register</h2>
    <input id="regEmail" placeholder="Email">
    <input id="regPassword" type="password" placeholder="Password">
    <input id="regUsername" placeholder="Username">
    <button onclick="register()">Create Account</button>
  </div>
</div>

<!-- CHAT HALL -->
<div id="hall">
  <div class="header">
    <div id="hallAvatar" class="avatar"></div>
    <span id="hallName" style="margin-left:12px;"></span>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import {
  getAuth,
  createUserWithEmailAndPassword,
  signInWithEmailAndPassword,
  onAuthStateChanged
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
import {
  getFirestore,
  doc,
  setDoc,
  getDoc,
  serverTimestamp
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyDCBD2gVIg9v-KqYaMFZeu_grgs3yKYfPs",
  authDomain: "fir-chat-f8d55.firebaseapp.com",
  projectId: "fir-chat-f8d55",
  storageBucket: "fir-chat-f8d55.firebasestorage.app",
  messagingSenderId: "792896094694",
  appId: "1:792896094694:web:dd373e5d7d2fc9ae1d5627"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

/* ---------- NAV ---------- */
function show(id){
  document.querySelectorAll(".page,#hall").forEach(p=>p.style.display="none");
  document.getElementById(id).style.display="flex";
}

window.goRegister = () => show("register");

/* ---------- REGISTER ---------- */
window.register = async () => {
  const email = regEmail.value.trim();
  const password = regPassword.value.trim();
  const username = regUsername.value.trim();

  if(!email || !password || !username) {
    alert("Fill all fields");
    return;
  }

  const cred = await createUserWithEmailAndPassword(auth, email, password);
  const uid = cred.user.uid;

  await setDoc(doc(db,"users",uid),{
    email,
    username,
    searchKey: username.toLowerCase(),
    createdAt: serverTimestamp()
  });

  loadHall(username);
};

/* ---------- LOGIN ---------- */
window.login = async () => {
  const email = loginEmail.value.trim();
  const password = loginPassword.value.trim();
  await signInWithEmailAndPassword(auth,email,password);
};

/* ---------- SESSION ---------- */
onAuthStateChanged(auth, async user=>{
  if(user){
    const snap = await getDoc(doc(db,"users",user.uid));
    if(snap.exists()){
      loadHall(snap.data().username);
    }
  }
});

/* ---------- CHAT HALL ---------- */
function loadHall(username){
  show("hall");
  hallAvatar.textContent = username[0].toUpperCase();
  hallName.textContent = username;
}
</script>

</body>
</html>
