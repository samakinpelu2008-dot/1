<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>IEM Chat Full</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
*{margin:0;padding:0;box-sizing:border-box;font-family:system-ui;}
body,html{height:100%;background:#0f1720;color:#e5e7eb;overflow:hidden;}
.app{height:100%;display:flex;flex-direction:column;}

/* Top bars */
.topbar, .chat-topbar{
  height:60px;
  display:flex;
  align-items:center;
  justify-content:space-between;
  padding:0 15px;
  border-bottom:1px solid #1f2c33;
  background:#0f1720;
  color:#e5e7eb;
}
.topbar h1, .chat-topbar .name{font-size:20px;font-weight:600;}
.avatar{
  width:40px;height:40px;background:#1f2c33;border-radius:50%;
  display:flex;align-items:center;justify-content:center;font-weight:bold;font-size:16px;
}
.menu, .back-btn{font-size:20px;cursor:pointer;}
.topbar button{background:#1f2c33;color:#e5e7eb;border:none;padding:5px 10px;border-radius:6px;cursor:pointer;}

/* Search */
.search{
  padding:10px;
  background:#111b21;
}
.search input{
  width:100%;
  padding:10px 15px;
  border-radius:25px;
  border:none;
  outline:none;
  background:#2a3942;
  color:white;
}

/* Chat list */
.chat-list{
  flex:1;
  overflow-y:auto;
}
.chat{
  display:flex;
  align-items:center;
  gap:12px;
  padding:12px 15px;
  border-bottom:1px solid #1f2c33;
  cursor:pointer;
}
.chat:hover{background:#1c262b;}
.name{font-size:16px;font-weight:600;}

/* Messages */
.messages{
  flex:1;
  padding:15px;
  overflow-y:auto;
  display:flex;
  flex-direction:column;
  gap:10px;
}
.message{
  max-width:70%;
  padding:10px 14px;
  border-radius:10px;
  font-size:14px;
  line-height:1.4;
  word-break: break-word;
}
.sent{background:#1f2c33;align-self:flex-end;border-bottom-right-radius:0;}
.received{background:#111827;align-self:flex-start;border-bottom-left-radius:0;}

/* Input */
.chat-input{
  display:flex;
  gap:10px;
  padding:10px;
  border-top:1px solid #1f2c33;
}
.chat-input input{
  flex:1;
  background:#111827;
  border:none;
  color:white;
  padding:12px;
  border-radius:20px;
  outline:none;
}
.chat-input button{
  width:45px;
  height:45px;
  border-radius:50%;
  border:none;
  background:#1f2c33;
  color:white;
  cursor:pointer;
}
</style>
</head>
<body>

<div id="app" class="app">

  <!-- CHAT HALL -->
  <div id="chatHall">
    <div class="topbar">
      <h1>IEM Chat</h1>
      <button onclick="logout()">Logout</button>
    </div>
    <div class="search">
      <input placeholder="Search contacts..." onkeyup="filterContacts(this.value)">
    </div>
    <div class="chat-list" id="contactsList"></div>
  </div>

  <!-- CHAT SCREEN -->
  <div id="chatScreen" style="display:none;flex-direction:column;height:100%;">
    <div class="chat-topbar">
      <div style="display:flex;align-items:center;gap:10px">
        <div class="back-btn" onclick="backToHall()">←</div>
        <div class="avatar" id="chatAvatar">C</div>
        <div class="name" id="chatName">Contact</div>
      </div>
      <div class="menu">⋮</div>
    </div>
    <div class="messages" id="messages"></div>
    <div class="chat-input">
      <input type="text" id="messageInput" placeholder="Type a message">
      <button id="sendBtn">➤</button>
    </div>
  </div>

</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
import { getFirestore, collection, onSnapshot, addDoc, query, orderBy } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyDCBD2gVIg9v-KqYaMFZeu_grgs3yKYfPs",
  authDomain: "fir-chat-f8d55.firebaseapp.com",
  projectId: "fir-chat-f8d55",
  storageBucket: "fir-chat-f8d55.appspot.com",
  messagingSenderId: "792896094694",
  appId: "1:792896094694:web:dd373e5d7d2fc9ae1d5627"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

let currentUserUid = null;
let currentContact = null;
let chatId = null;

// DOM references
const chatHall = document.getElementById("chatHall");
const chatScreen = document.getElementById("chatScreen");
const contactsList = document.getElementById("contactsList");
const chatName = document.getElementById("chatName");
const chatAvatar = document.getElementById("chatAvatar");
const messagesDiv = document.getElementById("messages");
const messageInput = document.getElementById("messageInput");
const sendBtn = document.getElementById("sendBtn");

let allContacts = [];
let unsubscribeMessages = null;

// AUTH
onAuthStateChanged(auth, user=>{
  if(!user) return;
  currentUserUid = user.uid;
  loadContacts();
});

// LOGOUT
window.logout = async()=>{ await signOut(auth); location.reload(); }

// LOAD CONTACTS
function loadContacts(){
  const ref = collection(db,"contacts",currentUserUid,"list");
  onSnapshot(ref,snap=>{
    allContacts = snap.docs.map(d=>({id:d.id,...d.data()}));
    renderContacts(allContacts);
  });
}

function renderContacts(list){
  contactsList.innerHTML="";
  list.forEach(c=>{
    const div=document.createElement("div");
    div.className="chat";
    div.innerHTML=`<div class="avatar">${(c.name||c.userId)[0].toUpperCase()}</div><div class="name">${c.name||c.userId}</div>`;
    div.onclick = ()=>openChat(c);
    contactsList.appendChild(div);
  });
}

// SEARCH
window.filterContacts = txt=>{
  renderContacts(allContacts.filter(c=>
    (c.name||c.userId).toLowerCase().includes(txt.toLowerCase())
  ));
}

// OPEN CHAT
function openChat(contact){
  currentContact = contact;
  chatId = [currentUserUid, contact.id].sort().join("_");
  chatName.textContent = contact.name || contact.userId;
  chatAvatar.textContent = (contact.name||contact.userId)[0].toUpperCase();
  chatHall.style.display="none";
  chatScreen.style.display="flex";
  listenMessages();
}

// BACK TO HALL
window.backToHall = ()=>{
  chatScreen.style.display="none";
  chatHall.style.display="flex";
  if(unsubscribeMessages) unsubscribeMessages();
}

// MESSAGES
function listenMessages(){
  messagesDiv.innerHTML="";
  const messagesRef = collection(db,"chats",chatId,"messages");
  const q = query(messagesRef, orderBy("timestamp","asc"));
  if(unsubscribeMessages) unsubscribeMessages();
  unsubscribeMessages = onSnapshot(q, snap=>{
    messagesDiv.innerHTML="";
    snap.forEach(doc=>{
      const m = doc.data();
      const div = document.createElement("div");
      div.className = "message "+(m.senderUid===currentUserUid?"sent":"received");
      div.textContent = m.text;
      messagesDiv.appendChild(div);
    });
    messagesDiv.scrollTop = messagesDiv.scrollHeight;
  });
}

// SEND MESSAGE
sendBtn.onclick = sendMessage;
messageInput.addEventListener("keydown", e=>{
  if(e.key==="Enter") sendMessage();
});
async function sendMessage(){
  const text = messageInput.value.trim();
  if(!text) return;
  const messagesRef = collection(db,"chats",chatId,"messages");
  await addDoc(messagesRef,{
    text,
    senderUid: currentUserUid,
    timestamp: Date.now()
  });
  messageInput.value="";
}
</script>
</body>
</html>
