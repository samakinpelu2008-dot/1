<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Chat Firebase</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
*{margin:0;padding:0;box-sizing:border-box;font-family:system-ui;}
body,html{height:100%;background:#0f1720;color:#e5e7eb;overflow:hidden;}

.chat-container{
  width:100%;
  max-width:420px;
  height:100vh;
  display:flex;
  flex-direction:column;
}

/* TOP BAR */
.chat-topbar{
  height:60px;
  background:#0f1720;
  display:flex;
  align-items:center;
  justify-content:space-between;
  padding:0 15px;
  border-bottom:1px solid #1f2c33;
}
.chat-user{display:flex;align-items:center;gap:10px;}
.avatar{
  width:40px;height:40px;background:#1f2c33;border-radius:50%;
  display:flex;align-items:center;justify-content:center;font-weight:bold;
}
.menu{font-size:20px;cursor:pointer;}
.name{font-size:16px;}

/* MESSAGES */
.messages{
  flex:1;
  padding:15px;
  overflow-y:auto;
  display:flex;
  flex-direction:column;
  gap:10px;
}
.message{
  max-width:70%;
  padding:10px 14px;
  border-radius:10px;
  font-size:14px;
  line-height:1.4;
  word-break: break-word;
}
.sent{background:#1f2c33;align-self:flex-end;border-bottom-right-radius:0;}
.received{background:#111827;align-self:flex-start;border-bottom-left-radius:0;}

/* INPUT */
.chat-input{
  display:flex;
  gap:10px;
  padding:10px;
  border-top:1px solid #1f2c33;
}
.chat-input input{
  flex:1;
  background:#111827;
  border:none;
  color:white;
  padding:12px;
  border-radius:20px;
  outline:none;
}
.chat-input button{
  width:45px;
  height:45px;
  border-radius:50%;
  border:none;
  background:#1f2c33;
  color:white;
  cursor:pointer;
}
</style>
</head>
<body>

<div class="chat-container">

  <!-- TOP BAR -->
  <div class="chat-topbar">
    <div class="chat-user">
      <div class="avatar" id="chatAvatar">S</div>
      <div class="name" id="chatName">Contact</div>
    </div>
    <div class="menu">⋮</div>
  </div>

  <!-- MESSAGES -->
  <div class="messages" id="messages"></div>

  <!-- INPUT -->
  <div class="chat-input">
    <input type="text" id="messageInput" placeholder="Type a message">
    <button id="sendBtn">➤</button>
  </div>

</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
import { getFirestore, collection, addDoc, query, orderBy, onSnapshot } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyDCBD2gVIg9v-KqYaMFZeu_grgs3yKYfPs",
  authDomain: "fir-chat-f8d55.firebaseapp.com",
  projectId: "fir-chat-f8d55",
  storageBucket: "fir-chat-f8d55.appspot.com",
  messagingSenderId: "792896094694",
  appId: "1:792896094694:web:dd373e5d7d2fc9ae1d5627"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

let currentUserUid = null;
let chatId = null; // will be computed based on two UIDs
let messagesDiv = document.getElementById("messages");
const input = document.getElementById("messageInput");
const sendBtn = document.getElementById("sendBtn");

onAuthStateChanged(auth, user=>{
  if(!user) return;
  currentUserUid = user.uid;

  // For testing: we’ll chat with another fixed UID (replace with real contact)
  const otherUid = "TESTCONTACTUID"; 
  chatId = [currentUserUid, otherUid].sort().join("_");

  listenMessages();
});

function listenMessages(){
  const messagesRef = collection(db, "chats", chatId, "messages");
  const q = query(messagesRef, orderBy("timestamp","asc"));

  onSnapshot(q, snapshot=>{
    messagesDiv.innerHTML="";
    snapshot.forEach(doc=>{
      const m = doc.data();
      const div = document.createElement("div");
      div.className = "message "+(m.senderUid===currentUserUid?"sent":"received");
      div.textContent = m.text;
      messagesDiv.appendChild(div);
    });
    messagesDiv.scrollTop = messagesDiv.scrollHeight;
  });
}

sendBtn.onclick = sendMessage;
input.addEventListener("keydown", e=>{
  if(e.key==="Enter") sendMessage();
});

async function sendMessage(){
  const text = input.value.trim();
  if(!text) return;

  const messagesRef = collection(db,"chats",chatId,"messages");
  await addDoc(messagesRef,{
    text,
    senderUid: currentUserUid,
    timestamp: Date.now()
  });
  input.value="";
}
</script>
</body>
</html>
